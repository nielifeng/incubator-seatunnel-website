<!doctype html>
<html lang="zh-CN" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.16">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/blog/rss.xml" title="Apache SeaTunnel RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/blog/atom.xml" title="Apache SeaTunnel Atom Feed">
<link rel="alternate" type="application/rss+xml" href="/zh-CN/user_cases/rss.xml" title="Apache SeaTunnel RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh-CN/user_cases/atom.xml" title="Apache SeaTunnel Atom Feed">
<script src="https://hm.baidu.com/hm.js?33a9aab233e1082f91e4e347ad716701" async></script><title data-rh="true">Blog | Apache SeaTunnel</title><meta data-rh="true" property="og:title" content="Blog | Apache SeaTunnel"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" property="og:url" content="https://seatunnel.apache.org/zh-CN/blog/page/2"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/zh-CN/image/favicon.ico"><link data-rh="true" rel="canonical" href="https://seatunnel.apache.org/zh-CN/blog/page/2"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/blog/page/2" hreflang="en"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/zh-CN/blog/page/2" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://seatunnel.apache.org/blog/page/2" hreflang="x-default"><link rel="stylesheet" href="/zh-CN/assets/css/styles.04990753.css">
<link rel="preload" href="/zh-CN/assets/js/runtime~main.41b866cf.js" as="script">
<link rel="preload" href="/zh-CN/assets/js/main.accb60dc.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:rgb(70, 125, 175, 0.8)" role="banner"><div class="announcementBarContent_KsVm">🤔 Have queries regarding Apache SeaTunnel, Join Slack channel to discuss them join <a target="_blank" rel="noopener noreferrer" href="https://join.slack.com/t/apacheseatunnel/shared_invite/zt-123jmewxe-RjB_DW3M3gV~xL91pZ0oVQ">#SeaTunnel</a> channel! 🌟</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/zh-CN/"><div class="navbar__logo"><img src="/zh-CN/image/logo.png" alt="Apache SeaTunnel Logo" class="themedImage_W2Cr themedImage--light_TfLj"><img src="/zh-CN/image/logo.png" alt="Apache SeaTunnel Logo" class="themedImage_W2Cr themedImage--dark_oUvU"></div><b class="navbar__title">Apache SeaTunnel</b></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/zh-CN/">首页</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">文档</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/zh-CN/docs/2.3.0/about">2.3.0</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.3.0-beta/about">2.3.0-beta</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.2.0-beta/intro/about">2.2.0-beta</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.3/intro/about">2.1.3</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.2/intro/about">2.1.2</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.1/intro/about">2.1.1</a></li><li><a class="dropdown__link" href="/zh-CN/docs/2.1.0/introduction">2.1.0</a></li><li><a class="dropdown__link" href="/zh-CN/docs/1.x/introduction">1.x(Not Apache Release)</a></li><li><a class="dropdown__link" href="/zh-CN/docs/about">Next</a></li><li><a class="dropdown__link" href="/zh-CN/versions/">All versions</a></li></ul></div><a class="navbar__item navbar__link" href="/zh-CN/download">下载</a><a class="navbar__item navbar__link" href="/zh-CN/community/contribution_guide/contribute">社区</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh-CN/blog">博客</a><a class="navbar__item navbar__link" href="/zh-CN/user_cases">用户案例</a><a class="navbar__item navbar__link" href="/zh-CN/team">团队</a><a class="navbar__item navbar__link" href="/zh-CN/user">用户</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link">Apache</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">基金会</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">证书</a></li><li><a href="https://www.apache.org/events/current-event" target="_blank" rel="noopener noreferrer" class="dropdown__link">事件</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">安全</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">赞助</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">致谢</a></li></ul></div><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-list-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_a9qW thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_uKok margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Kvuv"><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/Apache IoTDB (Internet of Things Database) is a software system that integrates the collection">SeaTunnel supports IoTDB to implement IoT data synchronization</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/Apache SeaTunnel Committer | Zongwen Li">SeaTunnel engine, designed for tens-of-billions data integration</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/During the joint Apache SeaTunnel &amp; IoTDB Meetup on October 15,">Mafengwo finally chose Apache SeaTunnel after analyzing these 9 points of how it works!</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022/09/20/A-tutorial-to-help-you develop-a-SeaTunnel-Connector-hand-by-hand-while-avoiding -pitfalls">A tutorial to help you develop a SeaTunnel Connector hand-by-hand while avoiding pitfalls</a></li><li class="sidebarItem_CF0Q"><a class="sidebarItemLink_miNk" href="/zh-CN/blog/2022/09/19/Code-Demo-for-SeaTunnel-Connector-Development-Process">Code Demo for SeaTunnel Connector Development Process</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/2022/05/01/_Kidswant">SeaTunnel 在孩子王的选型过程及应用改造实践</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-05-01T00:00:00.000Z" itemprop="datePublished">2022年5月1日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" src="/zh-CN/assets/images/0-38f7968af0b7239e9d427a85adee4452.png" width="1920" height="1080"></p><p>在Apache SeaTunnel(Incubating) 4 月Meetup上，孩子王大数据专家、OLAP平台架构师 袁洪军 为我们带来了《Apache SeaTunnel (Incubating)在孩子王的应用实践》。</p><p>本次演讲主要包含五个部分：</p><ul><li><p>孩子王引入Apache SeaTunnel (Incubating)的背景介绍</p></li><li><p>大数据处理主流工具对比分析</p></li><li><p>Apache SeaTunnel (Incubating)的落地实践</p></li><li><p>Apache SeaTunnel (Incubating)改造中的常见问题</p></li><li><p>对孩子王未来发展方向的预测展望</p></li></ul><p><img loading="lazy" src="/zh-CN/assets/images/0-1-4c853aa726b29acc5954ba53240dc2b8.png" width="2578" height="2567"></p><p>袁洪军</p><p>孩子王 大数据专家、OLAP 平台架构师。多年大数据平台研发管理经验，在数据资产、血缘图谱、数据治理、OLAP 等领域有着丰富的研究经验。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="01-背景介绍">01 背景介绍<a class="hash-link" href="#01-背景介绍" title="Direct link to heading">​</a></h2><p><img loading="lazy" src="/zh-CN/assets/images/1-b67aae24cc6274ca2d6a4541848b847d.png" width="1583" height="979"></p><p>目前孩子王的OLAP平台主要包含元数据层、任务层、存储层、SQL层、调度层、服务层以及监控层七部分，本次分享主要关注任务层中的离线任务。</p><p>其实孩子王内部有一套完整的采集推送系统，但由于一些历史遗留问题，公司现有的平台无法快速支持OLAP平台上线，因此当时公司只能选择放弃自身的平台，转而着手研发新的系统。</p><p>当时摆在OLAP面前的有三个选择：</p><p>1、给予采集推送系统做二次研发；</p><p>2、完全自研；</p><p>3、参与开源项目。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="02-大数据处理主流工具对比分析">02 大数据处理主流工具对比分析<a class="hash-link" href="#02-大数据处理主流工具对比分析" title="Direct link to heading">​</a></h2><p>而这三项选择却各有优劣。若采基于采集推送做二次研发，其优点是有前人的经验，能够避免重复踩坑。但缺点是代码量大，研读时间、研读周期较长，而且抽象代码较少，与业务绑定的定制化功能较多，这也导致了其二开的难度较大。</p><p>若完全自研，其优点第一是开发过程自主可控，第二是可以通过Spark等一些引擎做贴合我们自身的架构，但缺点是可能会遭遇一些未知的问题。</p><p>最后如果使用开源框架，其优点一是抽象代码较多，二是经过其他大厂或公司的验证，框架在性能和稳定方面能够得到保障。因此孩子王在OLAP数据同步初期，我们主要研究了DATAX、Sqoop和SeaTunnel这三个开源数据同步工具。</p><p><img loading="lazy" src="/zh-CN/assets/images/2-a6b8a591b0c27aed589b35565edf7c02.png" width="876" height="915"></p><p>从脑图我们可以看到，Sqoop的主要功能是针对RDB的数据同步，其实现方式是基于MAP/REDUCE。Sqoop拥有丰富的参数和命令行可以去执行各种操作。Sqoop的优点在于它首先贴合Hadoop生态，并已经支持大部分RDB到HIVE任意源的转换，拥有完整的命令集和API的分布式数据同步工具。</p><p>但其缺点是Sqoop只支持RDB的数据同步，并且对于数据文件有一定的限制，以及还没有数据清洗的概念。</p><p><img loading="lazy" src="/zh-CN/assets/images/3-3ff7bcde6e57af360cccd3d50e713b8e.png" width="2452" height="1485"></p><p>DataX的主要功能是任意源的数据同步，通过配置化文件+多线程的方式实现，主要分为三个流程：Reader、Framework和Writer，其中Framework主要起到通信和留空的作用。</p><p>DataX的优点是它采用了插件式的开发，拥有自己的流控和数据管控，在社区活跃度上，DataX的官网上提供了许多不同源的数据推送。但DataX的缺点在于它基于内存，对数据量可能存在限制。</p><p><img loading="lazy" src="/zh-CN/assets/images/4-96dfdedcf3c28bf69a805f20cc51e960.png" width="2199" height="1860"></p><p>Apache SeaTunnel (Incubating)做的也是任意源的数据同步，实现流程分为source、transform和sink三步，基于配置文件、Spark或Flink实现。其优点是目前官网2.1.0有非常多的插件和源的推送，基于插件式的思想也使其非常容易扩展，拥抱Spark和Flink的同时也做到了分布式的架构。要说Apache SeaTunnel (Incubating)唯一的缺点可能是目前缺少IP的调用，UI界面需要自己做管控。</p><p>综上所述，Sqoop虽然是分布式，但是仅支持RDB和HIVE、Hbase之间的数据同步且扩展能力差，不利于二开。DataX扩展性好，整体性稳定，但由于是单机版，无法分布式集群部署，且数据抽取能力和机器性能有强依赖关系。而SeaTunnel和DataX类似并弥补了DataX非分布式的问题，对于实时流也做了很好的支持，虽然是新产品，但社区活跃度高。基于是否支持分布式、是否需要单独机器部署等诸多因素的考量，最后我们选择了SeaTunnel。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="03-apache-seatunnel-incubating的落地实践">03 Apache SeaTunnel (Incubating)的落地实践<a class="hash-link" href="#03-apache-seatunnel-incubating的落地实践" title="Direct link to heading">​</a></h2><p>在Apache SeaTunnel (Incubating)的官网我们可以看到Apache SeaTunnel (Incubating)的基础流程包括source、transform和sink三部分。根据官网的指南，Apache SeaTunnel (Incubating)的启动需要配置脚本，但经过我们的研究发现，Apache SeaTunnel (Incubating)的最终执行是依赖config文件的spark-submit提交的一个Application应用。</p><p>这种初始化方式虽然简单，但存在必须依赖Config文件的问题，每次运行任务后都会生成再进行清除，虽然可以在调度脚本中动态生成，但也产生了两个问题。1、频繁的磁盘操作是否有意义；2、是否存在更为高效的方式支持Apache SeaTunnel (Incubating)的运行。</p><p><img loading="lazy" src="/zh-CN/assets/images/5-94809b2d6f1fbbac48a249728119e5af.png" width="1597" height="973"></p><p>基于以上考量，在最终的设计方案中，我们增加了一个统一配置模板平台模块。调度时只需要发起一个提交命令，由Apache SeaTunnel (Incubating)自身去统一配置模板平台中拉取配置信息，再去装载和初始化参数。</p><p><img loading="lazy" src="/zh-CN/assets/images/5-1-05477f37c0f5e72755d1335853ea650e.png" width="1496" height="1022"></p><p>上图展示的便是孩子王OLAP的业务流程，主要分为三块。数据从Parquet，即Hive，通过Parquet表的方式到KYLIN和CK source的整体流程。</p><p><img loading="lazy" src="/zh-CN/assets/images/7-1317712145fdcaee3b0219f09f68a739.png" width="1205" height="766"></p><p>这是我们建模的页面，主要通过拖拉拽的方式生成最终模型，每个表之间通过一些交易操作，右侧是针对Apache SeaTunnel (Incubating)的微处理。</p><p><img loading="lazy" src="/zh-CN/assets/images/8-d476fef7e065db158f63dd1b3291543b.jpg" width="1306" height="609"></p><p>因此我们最终提交的命令如上，其中标红的首先是【-conf customconfig/jars】，指用户可以再统一配置模板平台进行处理，或者建模时单独指定。最后标红的【421 $start_time $end_time $taskType】Unicode，属于唯一编码。</p><p>下方图左就是我们最终调度脚本提交的38个命令，下方图右是针对Apache SeaTunnel (Incubating)做的改造，可以看到一个较为特殊的名为WaterdropContext的工具类。可以首先判断Unicode是否存在，再通过Unicode_code来获取不同模板的配置信息，避免了config文件的操作。</p><p>在最后的reportMeta则是用于在任务执行完成后上报一些信息，这也会在Apache SeaTunnel (Incubating)中完成。</p><p><img loading="lazy" src="/zh-CN/assets/images/9-018ad4a2a0de58d2d3c9c69fffbcd06c.png" width="1136" height="940"></p><p><img loading="lazy" src="/zh-CN/assets/images/10-f0199109244a92f734e89024bef0b51b.png" width="944" height="388"></p><p><img loading="lazy" src="data:image/png;base64,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s7IJECBAgAABAs8QKAuvz5izWRAgQIAAAQIECDQqUBBeu21XR1QbXWZlEyBAgAABAgSeIRANr+cl1y4QO43wjJvJLAgQIECAAAECZwtEw2tXR36s1bFZ87xYfLad/gkQIECAAAECBC4WiIbXbn80fbr6HB64eJEMR4AAAQIECBAgkASi4TW1Tnuux+68WgkCBAgQIECAAAECQYGy8Nrffw0OoBkBAgQIECBAgACBowTKwutRo+Z+bOIeTqpDAgQIECBAgMCDBSqH13yO9sHEpkaAAAECBAgQIHCUQOXwetQ09EOAAAECBAgQIPAGAeH1DatsjgQIECBAgACBhwgIrw9ZSNMgQIAAAQIECLxBQHh9wyqbIwECBAgQIEDgIQLC60MW0jQIECBAgAABAm8QEF7fsMrmSIAAAQIECBB4iIDw+pCFNA0CBAgQIECAwBsETgmv3asHvH3gDXePORIgQIAAAQIELhY4Jbx2rx64eBqGI0CAAAECBAgQeINANLymzdT8eQONORIgQIAAAQIECNxNIBpeu7rTq1y90PVuS6geAgQIECBAgMB7BArC63tQzJQAAQIECBAgQOCeAgXh1ZmBey6hqggQIECAAAEC7xEoCK/5zEDkSQJd40iz90CbKQECBAgQIECAwH6BaHgtfYBAl1xLL9k/GT0QIECAAAECBAg8WyAaXm2jPvs+MDsCBAgQIECAQBMC0fCajgGkjy3VJpZWkQQIECBAgACB5wlEw2s3c8/Jet7ymxEBAgQIECBAoC2BgvAan5gzBnErLQkQIECAAAECBOICp4RXLzKIL4CWBAgQIECAAAECcYFTwmt8eC0JECBAgAABAgQIxAWE17iVlgQIECBAgAABApUFhNfKC2B4AgQIECBAgACBuIDwGrfSkgABAgQIECBAoLKA8Fp5AQxPgAABAgQIECAQFxBe41ZaEiBAgAABAgQIVBYQXisvgOEJECBAgAABAgTiAsJr3EpLAgQIECBAgACBygLCa+UFMDwBAgQIECBAgEBcoCy8du999erXOK6WBAgQIECAAAECxwoUhNcutqb3vsqvx66B3ggQIECAAAECBIIC0fCakmvqNP8QHEMzAgQIECBAgAABAocIRMNrGsyxgUPQdUKAAAECBAgQILBNoCC8OjawjdhVBAgQIECAAAECRwkUhFenBY5C1w8BAgQIECBA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" width="916" height="348"></p><p>在最终完成的config文件如上，值得注意的是在transform方面，孩子王做了一些改造。首先是针对手机或者身份证号等做脱敏处理，如果用户指定字段，就按照字段做，如果不指定字段就扫描所有字段，然后根据模式匹配，进行脱敏加密。</p><p>第二transform还支持自定义处理，如上文说道OLAP建模的时候说到。加入了HideStr，可以保留一串字符的前十个字段，加密后方的所有字符，在数据安全上有所保障。</p><p>然后，在sink端，我们为了支持任务的幂等性，我们加入了pre_sql，这主要完成的任务是数据的删除，或分区的删除，因为任务在生产过程中不可能只运行一次，一旦出现重跑或补数等操作，就需要这一部分为数据的不同和正确性做考量。</p><p>在图右方的一个Clickhouse的Sink端，这里我们加入了一个is_senseless_mode，它组成了一个读写分离的无感模式，用户在查询和补数的时候不感知整体区域，而是用到CK的分区转换，即名为MOVE PARTITION TO TABLE的命令进行操作的。</p><p>此处特别说明KYLIN的Sink端，KYLIN是一个非常特殊的源，拥有自己一整套数据录入的逻辑，而且，他有自己的监控页面，因此我们给予KYLIN的改造只是简单地调用其API操作，在使用KYLIN时也只是简单的API调用和不断轮询的状态，所以KYLIN这块的资源在统一模板配置平台就被限制地很小。</p><p><img loading="lazy" src="/zh-CN/assets/images/12-61af6fe2e1a38126ec03a0291e15c1bf.jpg" width="1307" height="593"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="04-apache-seatunnel-incubating改造中的常见问题">04 Apache SeaTunnel (Incubating)改造中的常见问题<a class="hash-link" href="#04-apache-seatunnel-incubating改造中的常见问题" title="Direct link to heading">​</a></h2><p>1、OOM&amp;Too many Parts</p><p>问题通常会出现在Hive到Hive的过程中，即使我们通过了自动资源的分配，但也存在数据突然间变大的情况，比如在举办了多次活动之后。这样的问题其实只能通过手动动态地调参，调整数据同步批量时间来避免。未来我们可能尽力去完成对于数据量的掌握，做到精细的控制。</p><p>2、字段、类型不一致问题</p><p>模型上线后，任务依赖的上游表或者字段，用户都会做一些修改，这些修改若无法感知，可能导致任务的失败。目前解决方法是依托血缘+快照的方式进行提前感知来避免错误。</p><p>3、自定义数据源&amp;自定义分隔符</p><p>如财务部门需要单独使用的分割符，或是jar信息，现在用户可以自己在统一配置模板平台指定加载额外jar信息以及分割符信息。</p><p>4、数据倾斜问题</p><p>这可能因为用户自己设置了并行度，但无法做到尽善尽美。这一块我们暂时还没有完成处理，后续的思路可能在Source模块中添加post处理，对数据进行打散，完成倾斜。</p><p>5、KYLIN全局字典锁问题</p><p>随着业务发展，一个cube无法满足用户使用，就能需要建立多个cube，如果多个cube之间用了相同的字段，就会遇到KYLIN全局字典锁的问题。目前解决的思路是把两个或多个任务之间的调度时间进行隔开，如果无法隔开，可以做一个分布式锁的控制。KYLIN的sink端必须要拿到锁才能运行。</p><p>05 对孩子王未来发展方向的预测展望</p><ul><li><p>多源数据同步，未来可能针对RDB源进行处理</p></li><li><p>基于实时Flink的实现</p></li><li><p>接管已有采集调度平台（主要解决分库分表的问题）</p></li><li><p>数据质量校验，像一些空值、整个数据的空置率、主时间的判断等</p></li></ul><p>我的分享就到这里，希望以后可以和社区多多交流，共同进步，谢谢！</p></div></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/智能化时代的数据集成技术革新">智能化时代的数据集成技术革新</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-04-08T00:00:00.000Z" itemprop="datePublished">2022年4月8日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p><img loading="lazy" alt="1" src="/zh-CN/assets/images/1-3abb262dd4a58a521e31f7249b2058d2.png" width="900" height="383"></p><p>可管理，可调用，可计算，可变现的数据资源才能成为资产，信息系统的互联互通使得多源和多维度的数据集成需求巨大，这就对数据处理和集成的工具提出了严苛的要求。</p><p>智能化时代，在“智慧城市”、“智慧治理”、“产品智能化”等的趋势下，企业大多面临如何实现高效数据推送，提高平台质量，以及保障数据安全的挑战。选对数据集成工具和平台，数据才能发挥出做大的作用。</p><p>Apache SeaTunnel (Incubating) 作为下一代高性能、分布式、海量数据集成框架，致力于让数据同步更简单，更高效，加快分布式数据处理能力在生产环境落地。</p><p>在 Apache SeaTunnel(Incubating) Meetup（2022 年 4 月 16日），Apache SeaTunnel(Incubating) 社区将邀请了 Apache SeaTunnel(Incubating)的资深用户，分享 Apache SeaTunnel(Incubating)在智能化生产环境中落地的最佳实践。此外，还会有贡献者现场进行 Apache SeaTunnel(Incubating)的源码解析，让你对 Apache SeaTunnel(Incubating)有一个更加全面而深入的了解。</p><p>无论你是对 Apache SeaTunnel(Incubating)抱有兴趣的初学者，还是在日常的生产实践中遭遇了复杂棘手的部署问题，都可以来到这里，与我们的讲师近距离沟通，得到你想要的答案。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="01-报-名-通-道">01 报 名 通 道<a class="hash-link" href="#01-报-名-通-道" title="Direct link to heading">​</a></h2><p>Apache SeaTunnel (Incubating) Meetup | 4 月线上直播报名通道已开启，赶快预约吧！</p><p>时间：2022-4-16 14:00-17:00</p><p>形式：线上直播</p><p>点击链接或扫码预约报名（免费）：</p><p><img loading="lazy" alt="2" src="/zh-CN/assets/images/2-e9c01734f2c74a12f59e2f3eecd2a2c6.png" width="300" height="300"></p><p>扫码预约报名</p><p><img loading="lazy" alt="3" src="/zh-CN/assets/images/4-b0dd1cb8a1432483e3f3202cbea5c271.png" width="498" height="507"></p><p>扫码进直播群</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="02-活-动-亮-点">02 活 动 亮 点<a class="hash-link" href="#02-活-动-亮-点" title="Direct link to heading">​</a></h2><ul><li>行业案例详解</li><li>特色功能分析</li><li>一线企业踩坑心得</li><li>开源社区实战攻略</li><li>行业技术专家面对面 Q&amp;A</li><li>惊喜礼品送不停</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="03-活-动-议-程">03 活 动 议 程<a class="hash-link" href="#03-活-动-议-程" title="Direct link to heading">​</a></h2><p>活动当天，将有来自孩子王、oppo 的工程师现场分享来自厂商的一线前沿实践经验，还有来自白鲸开源的高级工程师对 Apache SeaTunnel(Incubating)的重要功能更新进行“硬核”讲解，干货满满。</p><p><img loading="lazy" alt="4" src="/zh-CN/assets/images/5-f80f0bce07f15e8f83f603d16825dde4.png" width="1080" height="1075"></p><p>袁洪军 孩子王 大数据专家、OLAP 平台架构师</p><p>多年大数据平台研发管理经验，在数据资产、血缘图谱、数据治理、OLAP 等领域有着丰富的研究经验</p><p>演讲时间：14:00-14:40</p><p>演讲题目：Apache SeaTunnel(Incubating) 在孩子王的应用实践</p><p>演讲概要： 如何实现高效数据推送？如何提高平台质量？如何保障数据安全？孩子王又对 Apache SeaTunnel(Incubating)做了哪些改造？</p><p><img loading="lazy" alt="6" src="/zh-CN/assets/images/6-8f02c4507ef50d7a109ddf227c45a7a5.png" width="1080" height="1080"></p><p>范佳 白鲸开源  高级工程师 Apache SeaTunnel Contributor</p><p>演讲时间： 14:40-15:20</p><p>演讲题目： 基于 Apache SeaTunnel(Incubating)的 Clickhouse Bulk Load 实现</p><p>演讲概要： 通过扩展 Apache SeaTunnel(Incubating)的 Connector实现 Clickhouse的 bulk load 数据同步功能。</p><p><img loading="lazy" alt="7" src="/zh-CN/assets/images/7-8b4c7798dd107093cb31b526eb3d8476.png" width="1080" height="1078"></p><p>王子超 oppo 高级后端工程师</p><p>演讲时间： 15:50-16:30</p><p>演讲题目： oppo智能推荐样本中心基于 Apache SeaTunnel(Incubating)的技术革新</p><p>演讲概要： 介绍 oppo 智能推荐机器学习样本流程的演进及 Apache  SeaTunnel(Incubating) 在其中发挥的作用。</p><p>除了精彩的演讲之外，现场还设置了多个抽奖环节，参与抽奖有机会获得 Apache SeaTunnel(Incubating) 精美定制礼品，敬请期待~</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/meetup">Meetup</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/2.1.0-Released-Apache-SeaTunnel-Incubating-First-Apache-Release-Refactors-Kernel-and-Supports-Flink-Overall">2.1.0 Released! Apache SeaTunnel(Incubating) First Apache Release Refactors Kernel and Supports Flink Overall</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2022-03-18T00:00:00.000Z" itemprop="datePublished">2022年3月18日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>On December 9, 2021, Apache SeaTunnel(Incubating) entered the Apache Incubator, and after nearly four months of endeavor by the community contributors, we passed the first Apache version control in one go and released it on March 18, 2022. This means that version 2.1.0 is an official release that is safe for corporate and individual users to use, which has been voted on by the Apache SeaTunnel(Incubating) community and the Apache Incubator.</p><p><strong>Note:</strong> A <strong>software license</strong> is a legal instrument governing the use or redistribution of software. A typical software license grants the licensee, typically an end-user, permission to use one or more copies of the software in ways where such a use would otherwise potentially constitute copyright infringement of the software owner&#x27;s exclusive rights under copyright. Effectively, a software license is a contract between the software developer and the user that guarantees the user will not be sued within the scope of the license. </p><p>Before and after entering the incubator, we spent a lot of time sorting through the external dependencies of the entire project to ensure compliance. It is important to note that the choice of License for open source software does not necessarily mean that the project itself is compliant. While the stringent version control process of ASF ensures compliance and legal distribution of the software license maximumly.</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="release-note">Release Note<a class="hash-link" href="#release-note" title="Direct link to heading">​</a></h2><p>We bring the following <strong>key features</strong>to this release:</p><ol><li>The kernel of the microkernel plug-in architecture is overall optimized, which is mainly in Java. And a lot of improvements are made to command line parameter parsing, plug-in loading, etc. At the same time, the users (or contributors) can choose the language to develop plug-in extensions, which greatly reduces the development threshold of plug-ins.</li><li>Overall support for Flink, while the users are free to choose the underlying engine. This version also brings a large number of Flink plug-ins and welcomes anyone to contribute more.</li><li>Provide local development fast startup environment support (example), allow contributors or users quickly and smoothly start without changing any code to facilitate rapid local development debugging. This is certainly exciting news for contributors or users who need to customize their plugins. In fact, we&#x27;ve had a large number of contributors use this approach to quickly test the plugin in our pre-release testing.</li><li>With Docker container installation provided, users can deploy and install Apache SeaTunnel(Incubating) via Docker extremely fast, and we will iterate around Docker &amp; K8s in the future, any interesting proposal on this is welcomed.</li></ol><h2 class="anchor anchorWithStickyNavbar_mojV" id="specific-release-notes">Specific release notes：<a class="hash-link" href="#specific-release-notes" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="features">[Features]<a class="hash-link" href="#features" title="Direct link to heading">​</a></h3><ul><li>Use JCommander to do command line parameter parsing, making developers focus on the logic itself.</li><li>Flink is upgraded from 1.9 to 1.13.5, keeping compatibility with older versions and preparing for subsequent CDC.</li><li>Support for Doris, Hudi, Phoenix, Druid, and other Connector plugins, and you can find complete plugin support here <a href="/zh-CN/blog/page/[https://github.com/apache/incubator-seatunnel#plugins-supported-by-seatunnel%5D(https://github.com/apache/incubator-seatunnel#plugins-supported-by-seatunnel)">plugins-supported-by-seatunnel</a>.</li><li>Local development extremely fast starts environment support. It can be achieved by using the example module without modifying any code, which is convenient for local debugging.</li><li>Support for installing and trying out Apache SeaTunnel(Incubating) via Docker containers.</li><li>SQL component supports SET statements and configuration variables.</li><li>Config module refactoring to facilitate understanding for the contributors while ensuring code compliance (License) of the project.</li><li>Project structure realigned to fit the new Roadmap.</li><li>CI&amp;CD support, code quality automation control (more plans will be carried out to support CI&amp;CD development).</li></ul><h2 class="anchor anchorWithStickyNavbar_mojV" id="acknowledgments">Acknowledgments<a class="hash-link" href="#acknowledgments" title="Direct link to heading">​</a></h2><p>Thanks to the following contributors who participated in this version release (GitHub IDs, in no particular order).</p><p>Al-assad, BenJFan, CalvinKirs, JNSimba, JiangTChen, Rianico, TyrantLucifer, Yves-yuan, ZhangchengHu0923, agendazhang, an-shi-chi-fan, asdf2014, bigdataf, chaozwn, choucmei, dailidong, dongzl, felix-thinkingdata, fengyuceNv, garyelephant, kalencaya, kezhenxu94, legendtkl, leo65535, liujinhui1994, mans2singh, marklightning, mosence, nielifeng, ououtt, ruanwenjun, simon824, totalo, wntp, wolfboys, wuchunfu, xbkaishui, xtr1993, yx91490, zhangbutao, zhaomin1423, zhongjiajie, zhuangchong, zixi0825.</p><p>Also sincere gratitude to our Mentors: Zhenxu Ke, Willem Jiang, William Guo, LiDong Dai, Ted Liu, Kevin, JB for their help!</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="planning-for-the-next-few-releases">Planning for the next few releases:<a class="hash-link" href="#planning-for-the-next-few-releases" title="Direct link to heading">​</a></h2><ul><li>CDC support.</li><li>Support for the monitoring system.</li><li>UI system support.</li><li>More Connector and efficient Sink support, such as ClickHouse support will be available in the next release soon.
The follow-up <strong>Features</strong> are decided by the community consensus, and we sincerely appeal to more participation in the community construction.</li></ul><p>We need your attention and contributions:)</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="community-status">Community Status<a class="hash-link" href="#community-status" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_mojV" id="recent-development">Recent Development<a class="hash-link" href="#recent-development" title="Direct link to heading">​</a></h3><p>Since entering the Apache incubator, the contributor group has grown from 13 to 55 and continues to grow, with the average weekly community commits remaining at 20+. </p><p>Three contributors from different companies (Lei Xie, HuaJie Wang, Chunfu Wu) have been invited to become Committers on account of their contributions to the community. </p><p>We held two Meetups, where instructors from Bilibili, OPPO, Vipshop, and other companies shared their large-scale production practices based on SeaTunnel in their companies (we will hold one meetup monthly in the future, and welcome SeaTunnel users or contributors to come and share their stories about SeaTunnel).</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="users-of-apache-seatunnelincubating">Users of Apache SeaTunnel(Incubating)<a class="hash-link" href="#users-of-apache-seatunnelincubating" title="Direct link to heading">​</a></h3><p>Note: Only registered users are included.</p><p>Registered users of Apache SeaTunnel(Incubating) are shown below. If you are also using Apache SeaTunnel(Incubating), too, welcome to register on <a href="https://github.com/apache/incubator-seatunnel/issues/686" target="_blank" rel="noopener noreferrer">Who is using SeaTunne</a>!</p><div align="center"><img src="/image/20220321/1.png"></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="ppmcs-word">PPMC&#x27;s Word<a class="hash-link" href="#ppmcs-word" title="Direct link to heading">​</a></h2><p>LiFeng Nie, PPMC of Apache SeaTunnel(Incubating), commented on the first Apache version release. </p><p>From the first day entering Apache Incubating, we have been working hard to learn the Apache Way and various Apache policies. Although the first release took a lot of time (mainly for compliance), we think it was well worth it, and that&#x27;s one of the reasons we chose to enter Apache. We need to give our users peace of mind, and Apache is certainly the best choice, with its almost demanding license control that allows users to avoid compliance issues as much as possible and ensure that the software is circulating reasonably and legally. In addition, its practice of the Apache Way, such as public service mission, pragmatism, community over code, openness and consensus decision-making, and meritocracy, can drive the Apache SeaTunnel(Incubating) community to become more open, transparent, and diverse.</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/2-1-0">2.1.0</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/release">Release</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/hdfs-to-clickhouse">如何快速地把 HDFS 中的数据导入 ClickHouse</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">2021年12月30日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse 是面向 OLAP 的分布式列式 DBMS。我们部门目前已经把所有数据分析相关的日志数据存储至 ClickHouse 这个优秀的数据仓库之中，当前日数据量达到了 300 亿。</p><p>之前介绍的有关数据处理入库的经验都是基于实时数据流，数据存储在 Kafka 中，我们使用 Java 或者 Golang 将数据从 Kafka 中读取、解析、清洗之后写入 ClickHouse 中，这样可以实现数据的快速接入。然而在很多同学的使用场景中，数据都不是实时的，可能需要将 HDFS 或者是 Hive 中的数据导入 ClickHouse。有的同学通过编写 Spark 程序来实现数据的导入，那么是否有更简单、高效的方法呢。</p><p>目前开源社区上有一款工具 <strong>Seatunnel</strong>，项目地址 <a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seatunnel</a>，可以快速地将 HDFS 中的数据导入 ClickHouse。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="hdfs-to-clickhouse">HDFS To ClickHouse<a class="hash-link" href="#hdfs-to-clickhouse" title="Direct link to heading">​</a></h2><p>假设我们的日志存储在 HDFS 中，我们需要将日志进行解析并筛选出我们关心的字段，将对应的字段写入 ClickHouse 的表中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="log-sample">Log Sample<a class="hash-link" href="#log-sample" title="Direct link to heading">​</a></h3><p>我们在 HDFS 中存储的日志格式如下， 是很常见的 Nginx 日志</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token number">10.41</span><span class="token plain">.1.28 github.com </span><span class="token number">114.250</span><span class="token plain">.140.241 </span><span class="token number">0</span><span class="token plain">.001s </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;127.0.0.1:80&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token number">26</span><span class="token plain">/Oct/2018:03:09:32 +0800</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;GET /Apache/Seatunnel HTTP/1.1&quot;</span><span class="token plain"> </span><span class="token number">200</span><span class="token plain"> </span><span class="token number">0</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;-&quot;</span><span class="token plain"> - </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;Dalvik/2.1.0 (Linux; U; Android 7.1.1; OPPO R11 Build/NMF26X)&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;196&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;-&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;mainpage&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;443&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;-&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;172.16.181.129&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="clickhouse-schema">ClickHouse Schema<a class="hash-link" href="#clickhouse-schema" title="Direct link to heading">​</a></h3><p>我们的 ClickHouse 建表语句如下，我们的表按日进行分区</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE cms.cms_msg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">date</span><span class="token plain"> Date, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    datetime DateTime, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url String, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    request_time Float32, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status String, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">hostname</span><span class="token plain"> String, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    domain String, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    remote_addr String, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    data_size Int32, </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    pool String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token plain"> ENGINE </span><span class="token operator">=</span><span class="token plain"> MergeTree PARTITION BY </span><span class="token function" style="color:rgb(80, 250, 123)">date</span><span class="token plain"> ORDER BY </span><span class="token function" style="color:rgb(80, 250, 123)">date</span><span class="token plain"> SETTINGS index_granularity </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">16384</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-with-clickhouse">Seatunnel with ClickHouse<a class="hash-link" href="#seatunnel-with-clickhouse" title="Direct link to heading">​</a></h2><p>接下来会给大家详细介绍，我们如何通过 Seatunnel 满足上述需求，将 HDFS 中的数据写入 ClickHouse 中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel">Seatunnel<a class="hash-link" href="#seatunnel" title="Direct link to heading">​</a></h3><p><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">Seatunnel</a> 是一个非常易用，高性能，能够应对海量数据的实时数据处理产品，它构建在Spark之上。Seatunnel 拥有着非常丰富的插件，支持从 Kafka、HDFS、Kudu 中读取数据，进行各种各样的数据处理，并将结果写入 ClickHouse、Elasticsearch 或者 Kafka 中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><p>首先我们需要安装 Seatunnel，安装十分简单，无需配置系统环境变量</p><ol><li>准备 Spark 环境</li><li>安装 Seatunnel</li><li>配置 Seatunnel</li></ol><p>以下是简易步骤，具体安装可以参照 <a href="/zh-CN/docs/quick-start">Quick Start</a></p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> /usr/local</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://archive.apache.org/dist/spark/spark-2.2.0/spark-2.2.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">tar</span><span class="token plain"> -xvf https://archive.apache.org/dist/spark/spark-2.2.0/spark-2.2.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">wget</span><span class="token plain"> https://github.com/InterestingLab/seatunnel/releases/download/v1.1.1/seatunnel-1.1.1.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">unzip</span><span class="token plain"> seatunnel-1.1.1.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(189, 147, 249)">cd</span><span class="token plain"> seatunnel-1.1.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token function" style="color:rgb(80, 250, 123)">vim</span><span class="token plain"> config/seatunnel-env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 指定Spark安装路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token assign-left variable" style="color:rgb(189, 147, 249);font-style:italic">SPARK_HOME</span><span class="token operator">=</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">${SPARK_HOME</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">:-</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">usr</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">local</span><span class="token variable operator" style="color:rgb(189, 147, 249);font-style:italic">/</span><span class="token variable" style="color:rgb(189, 147, 249);font-style:italic">spark-2.2.0-bin-hadoop2.7}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-pipeline">seatunnel Pipeline<a class="hash-link" href="#seatunnel-pipeline" title="Direct link to heading">​</a></h3><p>我们仅需要编写一个 seatunnel Pipeline 的配置文件即可完成数据的导入。</p><p>配置文件包括四个部分，分别是 Spark、Input、filter 和 Output。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="spark">Spark<a class="hash-link" href="#spark" title="Direct link to heading">​</a></h4><p>这一部分是 Spark 的相关配置，主要配置 Spark 执行时所需的资源大小。</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;seatunnel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1g&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="input">Input<a class="hash-link" href="#input" title="Direct link to heading">​</a></h4><p>这一部分定义数据源，如下是从 HDFS 文件中读取 text 格式数据的配置案例。</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">input </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hdfs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hdfs://nomanode:8020/rowlog/accesslog&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access_log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">format</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;text&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="filter">Filter<a class="hash-link" href="#filter" title="Direct link to heading">​</a></h4><p>在 Filter 部分，这里我们配置一系列的转化，包括正则解析将日志进行拆分、时间转换将 HTTPDATE 转化为 ClickHouse 支持的日期格式、对 Number 类型的字段进行类型转换以及通过 SQL 进行字段筛减等</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 使用正则解析原始日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    grok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;raw_message&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pattern </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;%{IP:ha_ip}\\s%{NOTSPACE:domain}\\s%{IP:remote_addr}\\s%{NUMBER:request_time}s\\s\&quot;%{DATA:upstream_ip}\&quot;\\s\\[%{HTTPDATE:timestamp}\\]\\s\&quot;%{NOTSPACE:method}\\s%{DATA:url}\\s%{NOTSPACE:http_ver}\&quot;\\s%{NUMBER:status}\\s%{NUMBER:body_bytes_send}\\s%{DATA:referer}\\s%{NOTSPACE:cookie_info}\\s\&quot;%{DATA:user_agent}\&quot;\\s%{DATA:uid}\\s%{DATA:session_id}\\s\&quot;%{DATA:pool}\&quot;\\s\&quot;%{DATA:tag2}\&quot;\\s%{DATA:tag3}\\s%{DATA:tag4}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 将&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;格式的数据转换为</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># &quot;yyyy/MM/dd HH:mm:ss&quot;格式的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">date</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;timestamp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;datetime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_time_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_time_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;yyyy/MM/dd HH:mm:ss&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 使用SQL筛选关注的字段，并对字段进行处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 甚至可以通过过滤条件过滤掉不关心的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;select substring(date, 1, 10) as date, datetime, hostname, url, http_code, float(request_time), int(data_size), domain from access&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h4><p>最后我们将处理好的结构化数据写入 ClickHouse</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">output </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clickhouse </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">host</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;your.clickhouse.host:8123&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;seatunnel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access_log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fields </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;date&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;datetime&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hostname&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uri&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http_code&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;request_time&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;data_size&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;domain&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        username </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;username&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="running-seatunnel">Running seatunnel<a class="hash-link" href="#running-seatunnel" title="Direct link to heading">​</a></h3><p>我们将上述四部分配置组合成为我们的配置文件 <code>config/batch.conf</code>。</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token function" style="color:rgb(80, 250, 123)">vim</span><span class="token plain"> config/batch.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;seatunnel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;1g&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hdfs </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        path </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hdfs://nomanode:8020/rowlog/accesslog&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access_log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">format</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;text&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 使用正则解析原始日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    grok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;raw_message&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pattern </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;%{IP:ha_ip}\\s%{NOTSPACE:domain}\\s%{IP:remote_addr}\\s%{NUMBER:request_time}s\\s\&quot;%{DATA:upstream_ip}\&quot;\\s\\[%{HTTPDATE:timestamp}\\]\\s\&quot;%{NOTSPACE:method}\\s%{DATA:url}\\s%{NOTSPACE:http_ver}\&quot;\\s%{NUMBER:status}\\s%{NUMBER:body_bytes_send}\\s%{DATA:referer}\\s%{NOTSPACE:cookie_info}\\s\&quot;%{DATA:user_agent}\&quot;\\s%{DATA:uid}\\s%{DATA:session_id}\\s\&quot;%{DATA:pool}\&quot;\\s\&quot;%{DATA:tag2}\&quot;\\s%{DATA:tag3}\\s%{DATA:tag4}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 将&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;格式的数据转换为</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># &quot;yyyy/MM/dd HH:mm:ss&quot;格式的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token function" style="color:rgb(80, 250, 123)">date</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;timestamp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_field </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;datetime&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_time_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_time_format </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;yyyy/MM/dd HH:mm:ss&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 使用SQL筛选关注的字段，并对字段进行处理</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 甚至可以通过过滤条件过滤掉不关心的数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;select substring(date, 1, 10) as date, datetime, hostname, url, http_code, float(request_time), int(data_size), domain from access&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clickhouse </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        </span><span class="token function" style="color:rgb(80, 250, 123)">host</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;your.clickhouse.host:8123&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;seatunnel&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;access_log&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fields </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;date&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;datetime&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;hostname&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;uri&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;http_code&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;request_time&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;data_size&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;domain&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        username </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;username&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(255, 121, 198)">&quot;password&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行命令，指定配置文件，运行 Seatunnel，即可将数据写入 ClickHouse。这里我们以本地模式为例。</p><div class="codeBlockContainer_I0IT language-shell theme-code-block"><div class="codeBlockContent_wNvx shell"><pre tabindex="0" class="prism-code language-shell codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./bin/start-seatunnel.sh --config config/batch.conf -e client -m </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;local[2]&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>在这篇文章中，我们介绍了如何使用 Seatunnel 将 HDFS 中的 Nginx 日志文件导入 ClickHouse 中。仅通过一个配置文件便可快速完成数据的导入，无需编写任何代码。除了支持 HDFS 数据源之外，Seatunnel 同样支持将数据从 Kafka 中实时读取处理写入 ClickHouse 中。我们的下一篇文章将会介绍，如何将 Hive 中的数据快速导入 ClickHouse 中。</p><p>当然，Seatunnel 不仅仅是 ClickHouse 数据写入的工具，在 Elasticsearch 以及 Kafka等 数据源的写入上同样可以扮演相当重要的角色。</p><p>希望了解 Seatunnel 和 ClickHouse、Elasticsearch、Kafka 结合使用的更多功能和案例，可以直接进入官网 <a href="https://seatunnel.apache.org/" target="_blank" rel="noopener noreferrer">https://seatunnel.apache.org/</a></p><p>-- Power by <a href="https://github.com/InterestingLab" target="_blank" rel="noopener noreferrer">InterestingLab</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/hdfs">HDFS</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/click-house">ClickHouse</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/hive-to-clickhouse">如何快速地把 Hive 中的数据导入 ClickHouse</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">2021年12月30日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>ClickHouse是面向OLAP的分布式列式DBMS。我们部门目前已经把所有数据分析相关的日志数据存储至ClickHouse这个优秀的数据仓库之中，当前日数据量达到了300亿。</p><p>在之前的文章 <a href="/zh-CN/blog/page/i18n/zh-CN/docusaurus-plugin-content-blog/current/2021-12-30-hdfs-to-clickhouse.mdtent-blog/current/2021-12-30-hdfs-to-clickhouse.md">如何快速地把HDFS中的数据导入ClickHouse</a> 中我们提到过使用 Seatunnel <a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seatunnel</a> 对HDFS中的数据经过很简单的操作就可以将数据写入ClickHouse。HDFS中的数据一般是非结构化的数据，那么针对存储在Hive中的结构化数据，我们应该怎么操作呢？</p><p><img loading="lazy" src="/zh-CN/assets/images/hive-logo-c9aedd90b5ea9668c87fe25ad92a8e6c.png" width="962" height="518"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="hive-to-clickhouse">Hive to ClickHouse<a class="hash-link" href="#hive-to-clickhouse" title="Direct link to heading">​</a></h2><p>假定我们的数据已经存储在Hive中，我们需要读取Hive表中的数据并筛选出我们关心的字段，或者对字段进行转换，最后将对应的字段写入ClickHouse的表中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="hive-schema">Hive Schema<a class="hash-link" href="#hive-schema" title="Direct link to heading">​</a></h3><p>我们在Hive中存储的数据表结构如下，存储的是很常见的Nginx日志</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE `nginx_msg_detail`(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `hostname` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `domain` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `remote_addr` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `request_time` float,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `datetime` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `url` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `status` int,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `data_size` int,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `referer` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `cookie_info` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `user_agent` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `minute` string)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> PARTITIONED BY (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `date` string,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   `hour` string)</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="clickhouse-schema">ClickHouse Schema<a class="hash-link" href="#clickhouse-schema" title="Direct link to heading">​</a></h3><p>我们的ClickHouse建表语句如下，我们的表按日进行分区</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE cms.cms_msg</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">(</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date Date,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    datetime DateTime,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url String,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    request_time Float32,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status String,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hostname String,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    domain String,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    remote_addr String,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    data_size Int32</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">) ENGINE = MergeTree PARTITION BY date ORDER BY (date, hostname) SETTINGS index_granularity = 16384</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-with-clickhouse">Seatunnel with ClickHouse<a class="hash-link" href="#seatunnel-with-clickhouse" title="Direct link to heading">​</a></h2><p>接下来会给大家介绍，我们如何通过 Seatunnel 将Hive中的数据写入ClickHouse中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel">Seatunnel<a class="hash-link" href="#seatunnel" title="Direct link to heading">​</a></h3><p><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">Seatunnel</a> 是一个非常易用，高性能，能够应对海量数据的实时数据处理产品，它构建在Spark之上。Seatunnel 拥有着非常丰富的插件，支持从Kafka、HDFS、Kudu中读取数据，进行各种各样的数据处理，并将结果写入ClickHouse、Elasticsearch或者Kafka中。</p><p>Seatunnel的环境准备以及安装步骤这里就不一一赘述了，具体安装步骤可以参考上一篇文章或者访问 <a href="/zh-CN/docs/intro/about">Seatunnel Docs</a></p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-pipeline">Seatunnel Pipeline<a class="hash-link" href="#seatunnel-pipeline" title="Direct link to heading">​</a></h3><p>我们仅需要编写一个Seatunnel Pipeline的配置文件即可完成数据的导入。</p><p>配置文件包括四个部分，分别是Spark、Input、filter和Output。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="spark">Spark<a class="hash-link" href="#spark" title="Direct link to heading">​</a></h4><p>这一部分是Spark的相关配置，主要配置Spark执行时所需的资源大小。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // 这个配置必需填写</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql.catalogImplementation = &quot;hive&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="input">Input<a class="hash-link" href="#input" title="Direct link to heading">​</a></h4><p>这一部分定义数据源，如下是从Hive文件中读取text格式数据的配置案例。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hive {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pre_sql = &quot;select * from access.nginx_msg_detail&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>看，很简单的一个配置就可以从Hive中读取数据了。其中<code>pre_sql</code>是从Hive中读取数据SQL，<code>table_name</code>是将读取后的数据，注册成为Spark中临时表的表名，可为任意字段。</p><p>需要注意的是，必须保证hive的metastore是在服务状态。</p><p>在Cluster、Client、Local模式下运行时，必须把<code>hive-site.xml</code>文件置于提交任务节点的$HADOOP_CONF目录下</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="filter">Filter<a class="hash-link" href="#filter" title="Direct link to heading">​</a></h4><p>在Filter部分，这里我们配置一系列的转化，我们这里把不需要的minute和hour字段丢弃。当然我们也可以在读取Hive的时候通过<code>pre_sql</code>不读取这些字段</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    remove {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = [&quot;minute&quot;, &quot;hour&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h4><p>最后我们将处理好的结构化数据写入ClickHouse</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clickhouse {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        host = &quot;your.clickhouse.host:8123&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table = &quot;nginx_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fields = [&quot;date&quot;, &quot;datetime&quot;, &quot;hostname&quot;, &quot;url&quot;, &quot;http_code&quot;, &quot;request_time&quot;, &quot;data_size&quot;, &quot;domain&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        username = &quot;username&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="running-seatunnel">Running Seatunnel<a class="hash-link" href="#running-seatunnel" title="Direct link to heading">​</a></h3><p>我们将上述四部分配置组合成为我们的配置文件<code>config/batch.conf</code>。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim config/batch.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  // 这个配置必需填写</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql.catalogImplementation = &quot;hive&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hive {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pre_sql = &quot;select * from access.nginx_msg_detail&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    remove {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = [&quot;minute&quot;, &quot;hour&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    clickhouse {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        host = &quot;your.clickhouse.host:8123&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table = &quot;access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        fields = [&quot;date&quot;, &quot;datetime&quot;, &quot;hostname&quot;, &quot;uri&quot;, &quot;http_code&quot;, &quot;request_time&quot;, &quot;data_size&quot;, &quot;domain&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        username = &quot;username&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行命令，指定配置文件，运行 Seatunnel，即可将数据写入ClickHouse。这里我们以本地模式为例。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./bin/start-seatunnel.sh --config config/batch.conf -e client -m &#x27;local[2]&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>在这篇文章中，我们介绍了如何使用 Seatunnel 将Hive中的数据导入ClickHouse中。仅仅通过一个配置文件便可快速完成数据的导入，无需编写任何代码，十分简单。</p><p>希望了解 Seatunnel 与ClickHouse、Elasticsearch、Kafka、Hadoop结合使用的更多功能和案例，可以直接进入官网 <a href="https://seatunnel.apache.org/" target="_blank" rel="noopener noreferrer">https://seatunnel.apache.org/</a></p><p>-- Power by <a href="https://github.com/InterestingLab" target="_blank" rel="noopener noreferrer">InterestingLab</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/hive">Hive</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/click-house">ClickHouse</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/spark-execute-elasticsearch">如何使用 Spark 快速将数据写入 Elasticsearch</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">2021年12月30日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p>说到数据写入 Elasticsearch，最先想到的肯定是Logstash。Logstash因为其简单上手、可扩展、可伸缩等优点被广大用户接受。但是尺有所短，寸有所长，Logstash肯定也有它无法适用的应用场景，比如：</p><ul><li>海量数据ETL</li><li>海量数据聚合</li><li>多源数据处理</li></ul><p>为了满足这些场景，很多同学都会选择Spark，借助Spark算子进行数据处理，最后将处理结果写入Elasticsearch。</p><p>我们部门之前利用Spark对Nginx日志进行分析，统计我们的Web服务访问情况，将Nginx日志每分钟聚合一次最后将结果写入Elasticsearch，然后利用Kibana配置实时监控Dashboard。Elasticsearch和Kibana都很方便、实用，但是随着类似需求越来越多，如何快速通过Spark将数据写入Elasticsearch成为了我们的一大问题。</p><p>今天给大家推荐一款能够实现数据快速写入的黑科技 Seatunnel <a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seatunnel</a> 一个非常易用，高性能，能够应对海量数据的实时数据处理产品，它构建在Spark之上，简单易用，灵活配置，无需开发。</p><p><img loading="lazy" src="/zh-CN/assets/images/wd-struct-fd963482dc80fdee6e4930107709bd28.png" width="818" height="466"></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="kafka-to-elasticsearch">Kafka to Elasticsearch<a class="hash-link" href="#kafka-to-elasticsearch" title="Direct link to heading">​</a></h2><p>和Logstash一样，Seatunnel同样支持多种类型的数据输入，这里我们以最常见的Kakfa作为输入源为例，讲解如何使用 Seatunnel 将数据快速写入Elasticsearch</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="log-sample">Log Sample<a class="hash-link" href="#log-sample" title="Direct link to heading">​</a></h3><p>原始日志格式如下:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">127.0.0.1 elasticsearch.cn 114.250.140.241 0.001s &quot;127.0.0.1:80&quot; [26/Oct/2018:21:54:32 +0800] &quot;GET /article HTTP/1.1&quot; 200 123 &quot;-&quot; - &quot;Dalvik/2.1.0 (Linux; U; Android 7.1.1; OPPO R11 Build/NMF26X)&quot;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="elasticsearch-document">Elasticsearch Document<a class="hash-link" href="#elasticsearch-document" title="Direct link to heading">​</a></h3><p>我们想要统计，一分钟每个域名的访问情况，聚合完的数据有以下字段:</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">domain String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">hostname String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">status int</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">datetime String</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">count int</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-with-elasticsearch">Seatunnel with Elasticsearch<a class="hash-link" href="#seatunnel-with-elasticsearch" title="Direct link to heading">​</a></h2><p>接下来会给大家详细介绍，我们如何通过 Seatunnel 读取Kafka中的数据，对数据进行解析以及聚合，最后将处理结果写入Elasticsearch中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel">Seatunnel<a class="hash-link" href="#seatunnel" title="Direct link to heading">​</a></h3><p><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">Seatunnel</a> 同样拥有着非常丰富的插件，支持从Kafka、HDFS、Hive中读取数据，进行各种各样的数据处理，并将结果写入Elasticsearch、Kudu或者Kafka中。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h3><p>首先我们需要安装seatunnel，安装十分简单，无需配置系统环境变量</p><ol><li>准备Spark环境</li><li>安装 Seatunnel</li><li>配置 Seatunnel</li></ol><p>以下是简易步骤，具体安装可以参照 <a href="/zh-CN/docs/quick-start">Quick Start</a></p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd /usr/local</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//archive.apache.org/dist/spark/spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">2.2.0/spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">2.2.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">bin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tar </span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">xvf https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//archive.apache.org/dist/spark/spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">2.2.0/spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">2.2.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">bin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">//github.com/InterestingLab/seatunnel/releases/download/v1.1.1/seatunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.1.1.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unzip seatunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.1.1.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd seatunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">1.1.1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim config/seatunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)"># 指定Spark安装路径</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SPARK_HOME=$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">SPARK_HOME</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">/usr/local/spark</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">2.2.0</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">bin</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">hadoop2.7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-pipeline">Seatunnel Pipeline<a class="hash-link" href="#seatunnel-pipeline" title="Direct link to heading">​</a></h3><p>与Logstash一样，我们仅需要编写一个Seatunnel Pipeline的配置文件即可完成数据的导入，相信了解Logstash的朋友可以很快入手 Seatunnel 配置。</p><p>配置文件包括四个部分，分别是Spark、Input、filter和Output。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="spark">Spark<a class="hash-link" href="#spark" title="Direct link to heading">​</a></h4><p>这一部分是Spark的相关配置，主要配置Spark执行时所需的资源大小。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.streaming.batchDuration = 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="input">Input<a class="hash-link" href="#input" title="Direct link to heading">​</a></h4><p>这一部分定义数据源，如下是从Kafka中读取数据的配置案例，</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    topics = &quot;seatunnel-es&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    consumer.group.id = &quot;seatunnel_es_group&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    consumer.rebalance.max.retries = 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="filter">Filter<a class="hash-link" href="#filter" title="Direct link to heading">​</a></h4><p>在Filter部分，这里我们配置一系列的转化，包括正则解析将日志进行拆分、时间转换将HTTPDATE转化为Elasticsearch支持的日期格式、对Number类型的字段进行类型转换以及通过SQL进行数据聚合</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 使用正则解析原始日志</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 最开始数据都在raw_message字段中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    grok </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = &quot;raw_message&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pattern = &#x27;%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NOTSPACE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">hostname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NOTSPACE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">IP</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">remote_addr</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NUMBER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">request_time</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">s\\s\&quot;%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">DATA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">upstream_ip</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\&quot;\\s\\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token plain">%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">HTTPDATE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain">\\s\&quot;%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NOTSPACE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">method</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">DATA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">url</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NOTSPACE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">http_ver</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\&quot;\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NUMBER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NUMBER</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">body_bytes_send</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">DATA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">referer</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">NOTSPACE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">cookie_info</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">\\s\&quot;%</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">DATA</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">user_agent</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># 将&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;格式的数据转换为</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)"># Elasticsearch中支持的格式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = &quot;timestamp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_field = &quot;datetime&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_time_format = &quot;dd/MMM/yyyy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">HH</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">mm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">ss Z&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_time_format = &quot;yyyy</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">MM</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">dd&#x27;T&#x27;HH</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">mm</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">ss.SSS+08</span><span class="token punctuation" style="color:rgb(248, 248, 242)">:</span><span class="token plain">00&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token comment" style="color:rgb(98, 114, 164)">## 利用SQL对数据进行聚合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> int(status)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> datetime</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> count(</span><span class="token important">*)</span><span class="token plain"> from access_log group by domain</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> hostname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> datetime&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h4><p>最后我们将处理好的结构化数据写入Elasticsearch。</p><div class="codeBlockContainer_I0IT language-yaml theme-code-block"><div class="codeBlockContent_wNvx yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">output </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elasticsearch </span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        hosts = </span><span class="token punctuation" style="color:rgb(248, 248, 242)">[</span><span class="token string" style="color:rgb(255, 121, 198)">&quot;localhost:9200&quot;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        index = &quot;seatunnel</span><span class="token punctuation" style="color:rgb(248, 248, 242)">-</span><span class="token plain">$</span><span class="token punctuation" style="color:rgb(248, 248, 242)">{</span><span class="token plain">now</span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain">&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        es.batch.size.entries = 100000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        index_time_format = &quot;yyyy.MM.dd&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token punctuation" style="color:rgb(248, 248, 242)">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="running-seatunnel">Running Seatunnel<a class="hash-link" href="#running-seatunnel" title="Direct link to heading">​</a></h3><p>我们将上述四部分配置组合成为我们的配置文件 <code>config/batch.conf</code>。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim config/batch.conf</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.streaming.batchDuration = 5</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topics = &quot;seatunnel-es&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.group.id = &quot;seatunnel_es_group&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.rebalance.max.retries = 100</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 使用正则解析原始日志</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 最开始数据都在raw_message字段中</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    grok {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = &quot;raw_message&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pattern = &#x27;%{IP:hostname}\\s%{NOTSPACE:domain}\\s%{IP:remote_addr}\\s%{NUMBER:request_time}s\\s\&quot;%{DATA:upstream_ip}\&quot;\\s\\[%{HTTPDATE:timestamp}\\]\\s\&quot;%{NOTSPACE:method}\\s%{DATA:url}\\s%{NOTSPACE:http_ver}\&quot;\\s%{NUMBER:status}\\s%{NUMBER:body_bytes_send}\\s%{DATA:referer}\\s%{NOTSPACE:cookie_info}\\s\&quot;%{DATA:user_agent}&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">   }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # 将&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;格式的数据转换为</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Elasticsearch中支持的格式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_field = &quot;timestamp&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_field = &quot;datetime&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        source_time_format = &quot;dd/MMM/yyyy:HH:mm:ss Z&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        target_time_format = &quot;yyyy-MM-dd&#x27;T&#x27;HH:mm:00.SSS+08:00&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    ## 利用SQL对数据进行聚合</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select domain, hostname, status, datetime, count(*) from access_log group by domain, hostname, status, datetime&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    elasticsearch {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        hosts = [&quot;localhost:9200&quot;]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        index = &quot;seatunnel-${now}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        es.batch.size.entries = 100000</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        index_time_format = &quot;yyyy.MM.dd&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行命令，指定配置文件，运行 Seatunnel，即可将数据写入Elasticsearch。这里我们以本地模式为例。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">./bin/start-seatunnel.sh --config config/batch.conf -e client -m &#x27;local[2]&#x27;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>最后，写入Elasticsearch中的数据如下，再配上Kibana就可以实现Web服务的实时监控了^_^.</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">&quot;_source&quot;: {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;domain&quot;: &quot;elasticsearch.cn&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;hostname&quot;: &quot;localhost&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;status&quot;: &quot;200&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;datetime&quot;: &quot;2018-11-26T21:54:00.000+08:00&quot;,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    &quot;count&quot;: 26</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  }</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">​</a></h2><p>在这篇文章中，我们介绍了如何通过 Seatunnel 将Kafka中的数据写入Elasticsearch中。仅仅通过一个配置文件便可快速运行一个Spark Application，完成数据的处理、写入，无需编写任何代码，十分简单。</p><p>当数据处理过程中有遇到Logstash无法支持的场景或者Logstah性能无法达到预期的情况下，都可以尝试使用 Seatunnel 解决问题。</p><p>希望了解 Seatunnel 与Elasticsearch、Kafka、Hadoop结合使用的更多功能和案例，可以直接进入官网 <a href="https://seatunnel.apache.org/" target="_blank" rel="noopener noreferrer">https://seatunnel.apache.org/</a></p><p><strong>我们近期会再发布一篇《如何用Spark和Elasticsearch做交互式数据分析》，敬请期待.</strong></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="contract-us">Contract us<a class="hash-link" href="#contract-us" title="Direct link to heading">​</a></h2><ul><li>邮件列表 : <strong><a href="mailto:dev@seatunnel.apache.org" target="_blank" rel="noopener noreferrer">dev@seatunnel.apache.org</a></strong>. 发送任意内容至 <code>dev-subscribe@seatunnel.apache.org</code>， 按照回复订阅邮件列表。</li><li>Slack: 发送 <code>Request to join SeaTunnel slack</code> 邮件到邮件列表 (<code>dev@seatunnel.apache.org</code>), 我们会邀请你加入（在此之前请确认已经注册Slack）.</li><li><a href="https://space.bilibili.com/1542095008" target="_blank" rel="noopener noreferrer">bilibili B站 视频</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/spark">Spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/kafka">Kafka</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/elasticsearch">Elasticsearch</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/spark-execute-tidb">怎么用 Spark 在 TiDB 上做 OLAP 分析</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">2021年12月30日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><p><img src="https://download.pingcap.com/images/tidb-planet.jpg"></p><p><a href="https://github.com/pingcap/tidb" target="_blank" rel="noopener noreferrer">TiDB</a> 是一款定位于在线事务处理/在线分析处理的融合型数据库产品，实现了一键水平伸缩，强一致性的多副本数据安全，分布式事务，实时 OLAP 等重要特性。</p><p>TiSpark 是 PingCAP 为解决用户复杂 OLAP 需求而推出的产品。它借助 Spark 平台，同时融合 TiKV 分布式集群的优势。</p><p>直接使用 TiSpark 完成 OLAP 操作需要了解 Spark，还需要一些开发工作。那么，有没有一些开箱即用的工具能帮我们更快速地使用 TiSpark 在 TiDB 上完成 OLAP 分析呢？</p><p>目前开源社区上有一款工具 <strong>Seatunnel</strong>，项目地址 <a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seatunnel</a> ，可以基于Spark，在 TiSpark 的基础上快速实现 TiDB 数据读取和 OLAP 分析。</p><h2 class="anchor anchorWithStickyNavbar_mojV" id="使用-seatunnel-操作tidb">使用 Seatunnel 操作TiDB<a class="hash-link" href="#使用-seatunnel-操作tidb" title="Direct link to heading">​</a></h2><p>在我们线上有这么一个需求，从 TiDB 中读取某一天的网站访问数据，统计每个域名以及服务返回状态码的访问次数，最后将统计结果写入 TiDB 另外一个表中。 我们来看看 Seatunnel 是如何实现这么一个功能的。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel">Seatunnel<a class="hash-link" href="#seatunnel" title="Direct link to heading">​</a></h3><p><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">Seatunnel</a> 是一个非常易用，高性能，能够应对海量数据的实时数据处理产品，它构建在 Spark 之上。Seatunnel 拥有着非常丰富的插件，支持从 TiDB、Kafka、HDFS、Kudu 中读取数据，进行各种各样的数据处理，然后将结果写入 TiDB、ClickHouse、Elasticsearch 或者 Kafka 中。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="准备工作">准备工作<a class="hash-link" href="#准备工作" title="Direct link to heading">​</a></h4><h5 class="anchor anchorWithStickyNavbar_mojV" id="1-tidb-表结构介绍">1. TiDB 表结构介绍<a class="hash-link" href="#1-tidb-表结构介绍" title="Direct link to heading">​</a></h5><p><strong>Input</strong>（存储访问日志的表）</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE access_log (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    domain VARCHAR(255),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    datetime VARCHAR(63),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    remote_addr VARCHAR(63),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    http_ver VARCHAR(15),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    body_bytes_send INT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status INT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    request_time FLOAT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    url TEXT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------------+--------------+------+------+---------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Field           | Type         | Null | Key  | Default | Extra |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------------+--------------+------+------+---------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| domain          | varchar(255) | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| datetime        | varchar(63)  | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| remote_addr     | varchar(63)  | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| http_ver        | varchar(15)  | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| body_bytes_send | int(11)      | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| status          | int(11)      | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| request_time    | float        | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| url             | text         | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+-----------------+--------------+------+------+---------+-------+</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><strong>Output</strong>（存储结果数据的表）</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">CREATE TABLE access_collect (</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    date VARCHAR(23),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    domain VARCHAR(63),</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    status INT,</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    hit INT</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">+--------+-------------+------+------+---------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| Field  | Type        | Null | Key  | Default | Extra |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+--------+-------------+------+------+---------+-------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| date   | varchar(23) | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| domain | varchar(63) | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| status | int(11)     | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| hit    | int(11)     | YES  |      | NULL    |       |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+--------+-------------+------+------+---------+-------+</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="2-安装-seatunnel">2. 安装 Seatunnel<a class="hash-link" href="#2-安装-seatunnel" title="Direct link to heading">​</a></h5><p>有了 TiDB 输入和输出表之后， 我们需要安装 Seatunnel，安装十分简单，无需配置系统环境变量</p><ol><li>准备 Spark环境</li><li>安装 Seatunnel</li><li>配置 Seatunnel</li></ol><p>以下是简易步骤，具体安装可以参照 <a href="/zh-CN/docs/quick-start">Quick Start</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 下载安装Spark</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd /usr/local</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https://archive.apache.org/dist/spark/spark-2.1.0/spark-2.1.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tar -xvf https://archive.apache.org/dist/spark/spark-2.1.0/spark-2.1.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 下载安装seatunnel</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">https://github.com/InterestingLab/seatunnel/releases/download/v1.2.0/seatunnel-1.2.0.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unzip seatunnel-1.2.0.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd seatunnel-1.2.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim config/seatunnel-env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 指定Spark安装路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SPARK_HOME=${SPARK_HOME:-/usr/local/spark-2.1.0-bin-hadoop2.7}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="实现-seatunnel-处理流程">实现 Seatunnel 处理流程<a class="hash-link" href="#实现-seatunnel-处理流程" title="Direct link to heading">​</a></h3><p>我们仅需要编写一个 Seatunnel 配置文件即可完成数据的读取、处理、写入。</p><p>Seatunnel 配置文件由四个部分组成，分别是 <code>Spark</code>、<code>Input</code>、<code>Filter</code> 和 <code>Output</code>。<code>Input</code> 部分用于指定数据的输入源，<code>Filter</code> 部分用于定义各种各样的数据处理、聚合，<code>Output</code> 部分负责将处理之后的数据写入指定的数据库或者消息队列。</p><p>整个处理流程为 <code>Input</code> -&gt; <code>Filter</code> -&gt; <code>Output</code>，整个流程组成了 Seatunnel 的 处理流程（Pipeline）。</p><blockquote><p>以下是一个具体配置，此配置来源于线上实际应用，但是为了演示有所简化。</p></blockquote><h5 class="anchor anchorWithStickyNavbar_mojV" id="input-tidb">Input (TiDB)<a class="hash-link" href="#input-tidb" title="Direct link to heading">​</a></h5><p>这里部分配置定义输入源，如下是从 TiDB 一张表中读取数据。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tidb {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database = &quot;nginx&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pre_sql = &quot;select * from nginx.access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;spark_nginx_input&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="filter">Filter<a class="hash-link" href="#filter" title="Direct link to heading">​</a></h5><p>在Filter部分，这里我们配置一系列的转化, 大部分数据分析的需求，都是在Filter完成的。Seatunnel 提供了丰富的插件，足以满足各种数据分析需求。这里我们通过 SQL 插件完成数据的聚合操作。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;spark_nginx_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select count(*) as hit, domain, status, substring(datetime, 1, 10) as date from spark_nginx_log where substring(datetime, 1, 10)=&#x27;2019-01-20&#x27; group by domain, status, substring(datetime, 1, 10)&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="output-tidb">Output (TiDB)<a class="hash-link" href="#output-tidb" title="Direct link to heading">​</a></h5><p>最后， 我们将处理后的结果写入TiDB另外一张表中。TiDB Output是通过JDBC实现的</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tidb {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        url = &quot;jdbc:mysql://127.0.0.1:4000/nginx?useUnicode=true&amp;characterEncoding=utf8&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table = &quot;access_collect&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        user = &quot;username&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        save_mode = &quot;append&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h5 class="anchor anchorWithStickyNavbar_mojV" id="spark">Spark<a class="hash-link" href="#spark" title="Direct link to heading">​</a></h5><p>这一部分是 Spark 的相关配置，主要配置 Spark 执行时所需的资源大小以及其他 Spark 配置。</p><p>我们的 TiDB Input 插件是基于 TiSpark 实现的，而 TiSpark 依赖于 TiKV 集群和 Placement Driver (PD)。因此我们需要指定 PD 节点信息以及 TiSpark 相关配置<code>spark.tispark.pd.addresses</code>和<code>spark.sql.extensions</code>。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel-tidb&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  # Set for TiSpark</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.tispark.pd.addresses = &quot;localhost:2379&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.sql.extensions = &quot;org.apache.spark.sql.TiExtensions&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="运行-seatunnel">运行 Seatunnel<a class="hash-link" href="#运行-seatunnel" title="Direct link to heading">​</a></h4><p>我们将上述四部分配置组合成我们最终的配置文件 <code>conf/tidb.conf</code></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.app.name = &quot;seatunnel-tidb&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    # Set for TiSpark</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.tispark.pd.addresses = &quot;localhost:2379&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    spark.sql.extensions = &quot;org.apache.spark.sql.TiExtensions&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tidb {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        database = &quot;nginx&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        pre_sql = &quot;select * from nginx.access_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;spark_table&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;spark_nginx_log&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select count(*) as hit, domain, status, substring(datetime, 1, 10) as date from spark_nginx_log where substring(datetime, 1, 10)=&#x27;2019-01-20&#x27; group by domain, status, substring(datetime, 1, 10)&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    tidb {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        url = &quot;jdbc:mysql://127.0.0.1:4000/nginx?useUnicode=true&amp;characterEncoding=utf8&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table = &quot;access_collect&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        user = &quot;username&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        password = &quot;password&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        save_mode = &quot;append&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>执行命令，指定配置文件，运行 Seatunnel ，即可实现我们的数据处理逻辑。</p><ul><li>Local</li></ul><blockquote><p>./bin/start-seatunnel.sh --config config/tidb.conf --deploy-mode client --master &#x27;local<!-- -->[2]<!-- -->&#x27;</p></blockquote><ul><li>yarn-client</li></ul><blockquote><p>./bin/start-seatunnel.sh --config config/tidb.conf --deploy-mode client --master yarn</p></blockquote><ul><li>yarn-cluster</li></ul><blockquote><p>./bin/start-seatunnel.sh --config config/tidb.conf --deploy-mode cluster -master yarn</p></blockquote><p>如果是本机测试验证逻辑，用本地模式（Local）就可以了，一般生产环境下，都是使用<code>yarn-client</code>或者<code>yarn-cluster</code>模式。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="检查结果">检查结果<a class="hash-link" href="#检查结果" title="Direct link to heading">​</a></h4><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mysql&gt; select * from access_collect;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------+--------+--------+------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| date       | domain | status | hit  |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------+--------+--------+------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| 2019-01-20 | b.com  |    200 |   63 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">| 2019-01-20 | a.com  |    200 |   85 |</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">+------------+--------+--------+------+</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">2 rows in set (0.21 sec)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_mojV" id="总结">总结<a class="hash-link" href="#总结" title="Direct link to heading">​</a></h2><p>在这篇文章中，我们介绍了如何使用 Seatunnel 从 TiDB 中读取数据，做简单的数据处理之后写入 TiDB 另外一个表中。仅通过一个配置文件便可快速完成数据的导入，无需编写任何代码。</p><p>除了支持 TiDB 数据源之外，Seatunnel 同样支持Elasticsearch, Kafka, Kudu, ClickHouse等数据源。</p><p><strong>于此同时，我们正在研发一个重要功能，就是在 Seatunnel 中，利用 TiDB 的事务特性，实现从 Kafka 到 TiDB 流式数据处理，并且支持端（Kafka）到端（TiDB）的 Exactly-Once 数据一致性。</strong></p><p>希望了解 Seatunnel 和 TiDB，ClickHouse、Elasticsearch、Kafka结合使用的更多功能和案例，可以直接进入官网 <a href="https://seatunnel.apache.org/" target="_blank" rel="noopener noreferrer">https://seatunnel.apache.org/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="联系我们">联系我们<a class="hash-link" href="#联系我们" title="Direct link to heading">​</a></h2><ul><li>邮件列表 : <strong><a href="mailto:dev@seatunnel.apache.org" target="_blank" rel="noopener noreferrer">dev@seatunnel.apache.org</a></strong>. 发送任意内容至 <code>dev-subscribe@seatunnel.apache.org</code>， 按照回复订阅邮件列表。</li><li>Slack: 发送 <code>Request to join SeaTunnel slack</code> 邮件到邮件列表 (<code>dev@seatunnel.apache.org</code>), 我们会邀请你加入（在此之前请确认已经注册Slack）.</li><li><a href="https://space.bilibili.com/1542095008" target="_blank" rel="noopener noreferrer">bilibili B站 视频</a></li></ul><p>-- Power by <a href="https://github.com/InterestingLab" target="_blank" rel="noopener noreferrer">InterestingLab</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/spark">Spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/ti-db">TiDB</a></li></ul></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_rzP5" itemprop="headline"><a itemprop="url" href="/zh-CN/blog/spark-structured-streaming">如何支持的 Spark StructuredStreaming</a></h2><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">2021年12月30日</time> · <!-- -->One min read</div></header><div class="markdown" itemprop="articleBody"><h3 class="anchor anchorWithStickyNavbar_mojV" id="前言">前言<a class="hash-link" href="#前言" title="Direct link to heading">​</a></h3><p>StructuredStreaming是Spark 2.0以后新开放的一个模块，相比SparkStreaming，它有一些比较突出的优点：<br> <!-- --> <!-- --> <!-- -->一、它能做到更低的延迟;<br>
<!-- --> <!-- --> <!-- -->二、可以做实时的聚合，例如实时计算每天每个商品的销售总额；<br>
<!-- --> <!-- --> <!-- -->三、可以做流与流之间的关联，例如计算广告的点击率，需要将广告的曝光记录和点击记录关联。<br>
以上几点如果使用SparkStreaming来实现可能会比较麻烦或者说是很难实现，但是使用StructuredStreaming实现起来会比较轻松。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="如何使用structuredstreaming">如何使用StructuredStreaming<a class="hash-link" href="#如何使用structuredstreaming" title="Direct link to heading">​</a></h3><p>可能你没有详细研究过StructuredStreaming，但是发现StructuredStreaming能很好的解决你的需求，如何快速利用StructuredStreaming来解决你的需求？目前社区有一款工具 <strong>Seatunnel</strong>，项目地址：<a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer">https://github.com/apache/incubator-seatunnel</a> ,
可以高效低成本的帮助你利用StructuredStreaming来完成你的需求。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel">Seatunnel<a class="hash-link" href="#seatunnel" title="Direct link to heading">​</a></h3><p>Seatunnel 是一个非常易用，高性能，能够应对海量数据的实时数据处理产品，它构建在Spark之上。Seatunnel 拥有着非常丰富的插件，支持从Kafka、HDFS、Kudu中读取数据，进行各种各样的数据处理，并将结果写入ClickHouse、Elasticsearch或者Kafka中</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="准备工作">准备工作<a class="hash-link" href="#准备工作" title="Direct link to heading">​</a></h3><p>首先我们需要安装 Seatunnel，安装十分简单，无需配置系统环境变量</p><ol><li>准备Spark环境</li><li>安装 Seatunnel</li><li>配置 Seatunnel</li></ol><p>以下是简易步骤，具体安装可以参照 <a href="/zh-CN/docs/quick-start">Quick Start</a></p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd /usr/local</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https://archive.apache.org/dist/spark/spark-2.2.0/spark-2.2.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">tar -xvf https://archive.apache.org/dist/spark/spark-2.2.0/spark-2.2.0-bin-hadoop2.7.tgz</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">wget https://github.com/InterestingLab/seatunnel/releases/download/v1.3.0/seatunnel-1.3.0.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">unzip seatunnel-1.3.0.zip</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">cd seatunnel-1.3.0</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim config/seatunnel-env.sh</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 指定Spark安装路径</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">SPARK_HOME=${SPARK_HOME:-/usr/local/spark-2.2.0-bin-hadoop2.7}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="seatunnel-pipeline">Seatunnel Pipeline<a class="hash-link" href="#seatunnel-pipeline" title="Direct link to heading">​</a></h3><p>我们仅需要编写一个 Seatunnel Pipeline的配置文件即可完成数据的导入。</p><p>配置文件包括四个部分，分别是Spark、Input、filter和Output。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="spark">Spark<a class="hash-link" href="#spark" title="Direct link to heading">​</a></h4><p>这一部分是Spark的相关配置，主要配置Spark执行时所需的资源大小。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><h4 class="anchor anchorWithStickyNavbar_mojV" id="input">Input<a class="hash-link" href="#input" title="Direct link to heading">​</a></h4><p>下面是一个从kafka读取数据的例子</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    topics = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    schema = &quot;{\&quot;name\&quot;:\&quot;string\&quot;,\&quot;age\&quot;:\&quot;integer\&quot;,\&quot;addrs\&quot;:{\&quot;country\&quot;:\&quot;string\&quot;,\&quot;city\&quot;:\&quot;string\&quot;}}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>通过上面的配置就可以读取kafka里的数据了 ，topics是要订阅的kafka的topic，同时订阅多个topic可以以逗号隔开，consumer.bootstrap.servers就是Kafka的服务器列表，schema是可选项，因为StructuredStreaming从kafka读取到的值(官方固定字段value)是binary类型的，详见<a href="http://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html" target="_blank" rel="noopener noreferrer">http://spark.apache.org/docs/latest/structured-streaming-kafka-integration.html</a>
但是如果你确定你kafka里的数据是json字符串的话，你可以指定schema，input插件将按照你指定的schema解析</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="filter">Filter<a class="hash-link" href="#filter" title="Direct link to heading">​</a></h4><p>下面是一个简单的filter例子</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;student&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select name,age from student&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>table_name</code>是注册成的临时表名，以便于在下面的sql使用</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="output">Output<a class="hash-link" href="#output" title="Direct link to heading">​</a></h4><p>处理好的数据往外输出，假设我们的输出也是kafka</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">output{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafka {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topic = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        producer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        streaming_output_mode = &quot;update&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        checkpointLocation = &quot;/your/path&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p><code>topic</code> 是你要输出的topic，<code> producer.bootstrap.servers</code>是kafka集群列表，<code>streaming_output_mode</code>是StructuredStreaming的一个输出模式参数，有三种类型<code>append|update|complete</code>，具体使用参见文档<a href="http://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-modes" target="_blank" rel="noopener noreferrer">http://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#output-modes</a></p><p><code>checkpointLocation</code>是StructuredStreaming的checkpoint路径，如果配置了的话，这个目录会存储程序的运行信息，比如程序退出再启动的话会接着上次的offset进行消费。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="场景分析">场景分析<a class="hash-link" href="#场景分析" title="Direct link to heading">​</a></h3><p>以上就是一个简单的例子，接下来我们就来介绍的稍微复杂一些的业务场景</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="场景一实时聚合场景">场景一：实时聚合场景<a class="hash-link" href="#场景一实时聚合场景" title="Direct link to heading">​</a></h4><p>假设现在有一个商城，上面有10种商品，现在需要实时求每天每种商品的销售额，甚至是求每种商品的购买人数（不要求十分精确）。
这么做的巨大的优势就是海量数据可以在实时处理的时候，完成聚合，再也不需要先将数据写入数据仓库，再跑离线的定时任务进行聚合，
操作起来还是很方便的。</p><p>kafka的数据如下</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{&quot;good_id&quot;:&quot;abc&quot;,&quot;price&quot;:300,&quot;user_id&quot;:123456,&quot;time&quot;:1553216320}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>那我们该怎么利用 Seatunnel 来完成这个需求呢，当然还是只需要配置就好了。</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#spark里的配置根据业务需求配置</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#配置input</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topics = &quot;good_topic&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        schema = &quot;{\&quot;good_id\&quot;:\&quot;string\&quot;,\&quot;price\&quot;:\&quot;integer\&quot;,\&quot;user_id\&quot;:\&quot;Long\&quot;,\&quot;time\&quot;:\&quot;Long\&quot;}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#配置filter    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #在程序做聚合的时候，内部会去存储程序从启动开始的聚合状态，久而久之会导致OOM,如果设置了watermark，程序自动的会去清理watermark之外的状态</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #这里表示使用ts字段设置watermark，界限为1天</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Watermark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        time_field = &quot;time&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        time_type = &quot;UNIX&quot;              #UNIX表示时间字段为10为的时间戳，还有其他的类型详细可以查看插件文档</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        time_pattern = &quot;yyyy-MM-dd&quot;     #这里之所以要把ts对其到天是因为求每天的销售额，如果是求每小时的销售额可以对其到小时`yyyy-MM-dd HH`</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        delay_threshold = &quot;1 day&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        watermark_field = &quot;ts&quot;          #设置watermark之后会新增一个字段，`ts`就是这个字段的名字</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #之所以要group by ts是要让watermark生效，approx_count_distinct是一个估值，并不是精确的count_distinct</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;good_table_2&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select good_id,sum(price) total, approx_count_distinct(user_id) person from good_table_2 group by ts,good_id&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#接下来我们选择将结果实时输出到Kafka</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output{</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafka {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topic = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        producer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        streaming_output_mode = &quot;update&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        checkpointLocation = &quot;/your/path&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>如上配置完成，启动 Seatunnel，就可以获取你想要的结果了。</p><h4 class="anchor anchorWithStickyNavbar_mojV" id="场景二多个流关联场景">场景二：多个流关联场景<a class="hash-link" href="#场景二多个流关联场景" title="Direct link to heading">​</a></h4><p>假设你在某个平台投放了广告，现在要实时计算出每个广告的CTR(点击率)，数据分别来自两个topic，一个是广告曝光日志，一个是广告点击日志,
此时我们就需要把两个流数据关联到一起做计算，而 Seatunnel 最近也支持了此功能，让我们一起看一下该怎么做：</p><p>点击topic数据格式</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{&quot;ad_id&quot;:&quot;abc&quot;,&quot;click_time&quot;:1553216320,&quot;user_id&quot;:12345}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>曝光topic数据格式</p><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">{&quot;ad_id&quot;:&quot;abc&quot;,&quot;show_time&quot;:1553216220,&quot;user_id&quot;:12345}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><div class="codeBlockContainer_I0IT theme-code-block"><div class="codeBlockContent_wNvx"><pre tabindex="0" class="prism-code language-text codeBlock_jd64 thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_mRuA"><span class="token-line" style="color:#F8F8F2"><span class="token plain">#spark里的配置根据业务需求配置</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">spark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.app.name = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.instances = 2</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.cores = 1</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">  spark.executor.memory = &quot;1g&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#配置input</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">input {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topics = &quot;click_topic&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        schema = &quot;{\&quot;ad_id\&quot;:\&quot;string\&quot;,\&quot;user_id\&quot;:\&quot;Long\&quot;,\&quot;click_time\&quot;:\&quot;Long\&quot;}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;click_table&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafkaStream {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topics = &quot;show_topic&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        consumer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        schema = &quot;{\&quot;ad_id\&quot;:\&quot;string\&quot;,\&quot;user_id\&quot;:\&quot;Long\&quot;,\&quot;show_time\&quot;:\&quot;Long\&quot;}&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;show_table&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">filter {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #左关联右表必须设置watermark</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #右关左右表必须设置watermark</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    #http://spark.apache.org/docs/latest/structured-streaming-programming-guide.html#inner-joins-with-optional-watermarking</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Watermark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              source_table_name = &quot;click_table&quot; #这里可以指定为某个临时表添加watermark，不指定的话就是为input中的第一个</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              time_field = &quot;time&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              time_type = &quot;UNIX&quot;               </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              delay_threshold = &quot;3 hours&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              watermark_field = &quot;ts&quot; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">              result_table_name = &quot;click_table_watermark&quot; #添加完watermark之后可以注册成临时表，方便后续在sql中使用</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    Watermark {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                source_table_name = &quot;show_table&quot; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                time_field = &quot;time&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                time_type = &quot;UNIX&quot;               </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                delay_threshold = &quot;2 hours&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                watermark_field = &quot;ts&quot; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">                result_table_name = &quot;show_table_watermark&quot; </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    sql {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        table_name = &quot;show_table_watermark&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        sql = &quot;select a.ad_id,count(b.user_id)/count(a.user_id) ctr from show_table_watermark as a left join click_table_watermark as b on a.ad_id = b.ad_id and a.user_id = b.user_id &quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">#接下来我们选择将结果实时输出到Kafka</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">output {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    kafka {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        topic = &quot;seatunnel&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        producer.bootstrap.servers = &quot;localhost:9092&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        streaming_output_mode = &quot;append&quot; #流关联只支持append模式</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">        checkpointLocation = &quot;/your/path&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_wuS7 clean-btn">Copy</button></div></div><p>通过配置，到这里流关联的案例也完成了。</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="结语">结语<a class="hash-link" href="#结语" title="Direct link to heading">​</a></h3><p>通过配置能很快的利用StructuredStreaming做实时数据处理，但是还是需要对StructuredStreaming的一些概念了解，比如其中的watermark机制，还有程序的输出模式。</p><p>最后，Seatunnel 当然还支持spark streaming和spark 批处理。
如果你对这两个也感兴趣的话，可以阅读我们以前发布的文章《<a href="/zh-CN/blog/page/i18n/zh-CN/docusaurus-plugin-content-blog/current/2021-12-30-hive-to-clickhouse.mdtent-blog/current/2021-12-30-hive-to-clickhouse.md">如何快速地将Hive中的数据导入ClickHouse</a>》、
《<a href="/zh-CN/blog/page/i18n/zh-CN/docusaurus-plugin-content-blog/current/2021-12-30-spark-execute-tidb.mdtent-blog/current/2021-12-30-spark-execute-tidb.md">优秀的数据工程师，怎么用Spark在TiDB上做OLAP分析</a>》、
《<a href="/zh-CN/blog/page/i18n/zh-CN/docusaurus-plugin-content-blog/2021-12-30-spark-execute-elasticsearch.md/current/2021-12-30-spark-execute-elasticsearch.md">如何使用Spark快速将数据写入Elasticsearch</a>》</p><p>希望了解 Seatunnel 和 HBase, ClickHouse、Elasticsearch、Kafka、MySQL 等数据源结合使用的更多功能和案例，可以直接进入官网 <a href="https://seatunnel.apache.org/" target="_blank" rel="noopener noreferrer">https://seatunnel.apache.org/</a></p><h2 class="anchor anchorWithStickyNavbar_mojV" id="联系我们">联系我们<a class="hash-link" href="#联系我们" title="Direct link to heading">​</a></h2><ul><li>邮件列表 : <strong><a href="mailto:dev@seatunnel.apache.org" target="_blank" rel="noopener noreferrer">dev@seatunnel.apache.org</a></strong>. 发送任意内容至 <code>dev-subscribe@seatunnel.apache.org</code>， 按照回复订阅邮件列表。</li><li>Slack: 发送 <code>Request to join SeaTunnel slack</code> 邮件到邮件列表 (<code>dev@seatunnel.apache.org</code>), 我们会邀请你加入（在此之前请确认已经注册Slack）.</li><li><a href="https://space.bilibili.com/1542095008" target="_blank" rel="noopener noreferrer">bilibili B站 视频</a></li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/spark">Spark</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/zh-CN/blog/tags/structured-streaming">StructuredStreaming</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/zh-CN/blog"><div class="pagination-nav__label">Newer Entries</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">SeaTunnel</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/docs/faq">FAQ</a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/releases" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>版本<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">社区</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Issue Tracker<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/apache/incubator-seatunnel/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Pull Requests<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">订阅邮件组</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/zh-CN/community/contribution_guide/subscribe">How to Subscribe</a></li><li class="footer__item"><a href="mailto:dev-subscribe@seatunnel.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>订阅邮件<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://lists.apache.org/list.html?dev@seatunnel.apache.org" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>邮件归档<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><div style="margin-top: 20px;background: #f4f8fa">
                <img style="height:50px;margin-bottom: 10px" alt="Apache Software Foundation" src="/zh-CN/image/incubator-logo.svg">
                <p style="color: #999999;font-weight:400;text-align:left">Apache SeaTunnel is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</p>
                <div style="border-top: 1px solid #ccc;min-height: 60px;line-height: 20px;text-align: center;font-family: Avenir-Medium;font-size: 14px;color: #999;display: flex;align-items: center;"><span>Copyright © 2021-2022 The Apache Software Foundation. Apache SeaTunnel, SeaTunnel, and its feather logo are trademarks of The Apache Software Foundation.</span></div>
                <div style="text-align: center;">
                    <a href="https://twitter.com/asfseatunnel?s=21" target="_blank" title="Twitter"><svg t="1644553365083" class="icon" viewBox="0 0 1260 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="7015" width="25" height="25"><path d="M1259.846921 121.148242c-46.524504 20.728739-96.273478 34.547899-148.325646 40.536201 53.434084-31.784067 94.430924-82.454319 113.777747-142.797982-50.209613 29.480874-105.486251 51.13089-164.447999 62.646857A257.584528 257.584528 0 0 0 872.449815 0.000276c-142.797982 0-258.418284 115.620302-258.418284 258.418284 0 20.268101 2.303193 40.075563 6.909579 58.961748C405.82286 306.32498 215.579097 203.602561 87.98219 47.446058c-22.110655 38.233008-35.008538 82.454319-35.008538 129.900099 0 89.824537 45.603227 168.593747 115.159663 215.118251-42.378756-1.381916-81.99368-12.897882-117.002217-32.244706v3.224471c0 125.293713 88.90326 229.398049 207.287393 253.351259-21.650017 5.988302-44.681949 9.212773-68.17452 9.212773-16.582991 0-32.705344-1.842555-48.827697-4.606387 32.705344 102.722419 128.518184 177.345881 241.374653 179.649074-88.442621 69.095798-199.917175 110.553277-321.06514 110.553277-20.728739 0-41.457479-1.381916-61.72558-3.685109 114.238386 73.241546 250.126788 116.08094 396.149241 116.08094 475.379089 0 735.179289-393.846048 735.179289-735.179289 0-11.055328-0.460639-22.571294-0.921277-33.626621 51.13089-36.851092 94.891562-82.454319 129.439461-134.045848z" fill="#909094" p-id="7016"></path></svg></a> 
                    <a href="https://apacheseatunnel.slack.com" target="_blank" title="Slack" style="margin-left: 20px;"><svg t="1644553076784" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3088" width="23" height="23"><path d="M215.125333 647.04a107.861333 107.861333 0 0 1-107.52 107.648A107.861333 107.861333 0 0 1 0 647.04a107.818667 107.818667 0 0 1 107.605333-107.52h107.52v107.52z m54.229334 0a107.818667 107.818667 0 0 1 107.562666-107.52 107.818667 107.818667 0 0 1 107.562667 107.52v269.354667A107.861333 107.861333 0 0 1 376.917333 1024a107.861333 107.861333 0 0 1-107.562666-107.605333v-269.354667zM376.917333 215.125333a107.861333 107.861333 0 0 1-107.562666-107.52A107.861333 107.861333 0 0 1 376.917333 0a107.861333 107.861333 0 0 1 107.562667 107.605333v107.52H376.917333z m0 54.229334a107.861333 107.861333 0 0 1 107.562667 107.562666 107.861333 107.861333 0 0 1-107.562667 107.562667H107.605333A107.861333 107.861333 0 0 1 0 376.917333a107.861333 107.861333 0 0 1 107.605333-107.562666h269.312z m431.872 107.562666a107.861333 107.861333 0 0 1 107.605334-107.562666A107.861333 107.861333 0 0 1 1024 376.917333a107.861333 107.861333 0 0 1-107.605333 107.562667h-107.605334V376.917333z m-54.101333 0a107.861333 107.861333 0 0 1-107.648 107.562667 107.818667 107.818667 0 0 1-107.52-107.562667V107.605333A107.818667 107.818667 0 0 1 647.04 0a107.861333 107.861333 0 0 1 107.648 107.605333v269.312z m-107.648 431.872a107.861333 107.861333 0 0 1 107.648 107.605334A107.861333 107.861333 0 0 1 647.04 1024a107.818667 107.818667 0 0 1-107.52-107.605333v-107.605334h107.52z m0-54.101333a107.818667 107.818667 0 0 1-107.52-107.648 107.776 107.776 0 0 1 107.52-107.52h269.354667A107.818667 107.818667 0 0 1 1024 647.04a107.861333 107.861333 0 0 1-107.605333 107.648h-269.354667z" p-id="3089" fill="#909094"></path></svg></a> 
                    <a href="https://lists.apache.org/list.html?dev@seatunnel.apache.org" target="_blank" title="Mailing list" style="margin-left: 20px;"><svg t="1644553175467" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5304" width="26" height="26"><path d="M853.333333 170.666667H170.666667c-46.933333 0-85.333333 38.4-85.333334 85.333333v512c0 46.933333 38.4 85.333333 85.333334 85.333333h682.666666c46.933333 0 85.333333-38.4 85.333334-85.333333V256c0-46.933333-38.4-85.333333-85.333334-85.333333z m0 170.666666l-341.333333 213.333334-341.333333-213.333334V256l341.333333 213.333333 341.333333-213.333333v85.333333z" p-id="5305" fill="#909094"></path></svg></a> 
                    <a href="https://github.com/apache/incubator-seatunnel" target="_blank" title="GitHub" style="margin-left: 20px;"><svg t="1644553223000" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6156" width="23" height="23"><path d="M512 12.64c-282.752 0-512 229.216-512 512 0 226.208 146.72 418.144 350.144 485.824 25.6 4.736 35.008-11.104 35.008-24.64 0-12.192-0.48-52.544-0.704-95.328-142.464 30.976-172.512-60.416-172.512-60.416-23.296-59.168-56.832-74.912-56.832-74.912-46.464-31.776 3.52-31.136 3.52-31.136 51.392 3.616 78.464 52.768 78.464 52.768 45.664 78.272 119.776 55.648 148.992 42.56 4.576-33.088 17.856-55.68 32.512-68.48-113.728-12.928-233.28-56.864-233.28-253.024 0-55.904 20-101.568 52.768-137.44-5.312-12.896-22.848-64.96 4.96-135.488 0 0 43.008-13.76 140.832 52.48a491.296 491.296 0 0 1 128.16-17.248c43.488 0.192 87.328 5.888 128.256 17.248 97.728-66.24 140.64-52.48 140.64-52.48 27.872 70.528 10.336 122.592 5.024 135.488 32.832 35.84 52.704 81.536 52.704 137.44 0 196.64-119.776 239.936-233.792 252.64 18.368 15.904 34.72 47.04 34.72 94.816 0 68.512-0.608 123.648-0.608 140.512 0 13.632 9.216 29.6 35.168 24.576C877.472 942.624 1024 750.784 1024 524.64c0-282.784-229.248-512-512-512z" p-id="6157" fill="#909094"></path></svg></a> 
                </div>
            <div></div></div></div></div></div></footer></div>
<script src="/zh-CN/assets/js/runtime~main.41b866cf.js"></script>
<script src="/zh-CN/assets/js/main.accb60dc.js"></script>
</body>
</html>